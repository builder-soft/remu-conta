DROP PROCEDURE IF EXISTS pListDevelopHoliday;
DELIMITER $$

CREATE PROCEDURE pListDevelopHoliday(IN vEmployee BIGINT)
BEGIN
	DECLARE	vStartContract, vEndContract, vFirstDayYear, vLastDayYear, vStarPeriod, vEndPeriod DATE;
	DECLARE vStartYear, vEndYear INTEGER; 
	DECLARE	vContractType BIGINT DEFAULT '0';
	DECLARE vDiffDays DOUBLE DEFAULT '0';
	DECLARE i INTEGER DEFAULT '0';
	
	CREATE TEMPORARY TABLE tempTable(
		cId				BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY,	
		cYear			INTEGER,
		cNormal			DOUBLE,
		cProgressive	DOUBLE,
		cNormalTaken	DOUBLE,
		cProgressiveTaken	DOUBLE,
		cBalance		DOUBLE
	) ENGINE=innoDB;
	
	SELECT		cStartContract, cEndContract, cContractType
	INTO		vStartContract, vEndContract, vContractType
	FROM 		tAgreement
	WHERE		cEmployee = vEmployee;
	
	IF(vContractType = 1) THEN
		SET vEndContract = NOW(); 
	END IF;
/*
	SELECT vStartContract, vEndContract, vContractType;
*/
	SET vStartYear = YEAR(vStartContract);
	SET vEndYear = YEAR(vEndContract);
	
	SET i = vStartYear;
	
	WHILE i <= vEndYear DO
		SET vFirstDayYear = CONCAT(i, '-01-01');
		SET vLastDayYear = CONCAT(i, '-12-31');
		
		SET vStarPeriod = fGetLastDate(vStartContract, vFirstDayYear);
		SET vEndPeriod = fGetLessDate(vEndContract, vLastDayYear);
		
		/*select vStartContract, vFirstDayYear, vStarPeriod;
		select vEndContract, vLastDayYear, vEndPeriod;
		*/
		
		
		/*
		IF (vStartContract < vFirstDayYear) THEN
			SET vStarPeriod = vStartContract;
		ELSE
			SET vStarPeriod = vFirstDayYear;
		END IF;
		*/
		
		SET vDiffDays = fGetProportionalDays(vStarPeriod, vEndPeriod);
		
		INSERT INTO tempTable(cYear, cNormal) VALUES(i, vDiffDays);
		SET i = i + 1;
	END WHILE;

	/*
	SELECT vStartContract, vEndContract;
	SELECT * FROM tempTable ORDER BY cYear;
	*/

	SELECT * FROM tempTable;
	
	
	DROP TABLE tempTable;
	
END$$


DELIMITER ;

