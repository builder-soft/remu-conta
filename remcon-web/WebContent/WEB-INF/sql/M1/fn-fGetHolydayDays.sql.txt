DROP FUNCTION IF EXISTS fGetHolydayDays;
DROP PROCEDURE IF EXISTS fGetHolydayInfo;

DELIMITER $$

CREATE PROCEDURE fGetHolydayInfo(IN pEmployee BIGINT, IN pFrom DATE, IN pTo DATE)
/* Cálculo de vacaciones proporcionales 
Ref.: http://www.dt.gob.cl/consultas/1613/w3-article-60200.html

TODO: falta descontar los días de vacaciones.
*/
BEGIN
	DECLARE vDaysForYear INTEGER DEFAULT 15;
	DECLARE vDaysDiff, vProportional, vHolidayDays, vOut DOUBLE DEFAULT 0;
	
	SELECT	cValue
	INTO	vDaysForYear
	FROM	tParameter
	WHERE	cKey = 'DAYS_FOR_YEAR';
	
	SET		vDaysDiff = DateDiff(pTo, pFrom);
	SET		vProportional = (vDaysDiff * vDaysForYear) / 365;
	
	SET		vHolidayDays = (SELECT IFNULL(SUM(DateDiff(cTo, cFrom)), 0) 
							FROM tHoliday 
							WHERE cEmployee = pEmployee AND
								pFrom <= cFrom AND pTo >= cTo);
								
	SELECT	vProportional - vHolidayDays AS cHolidayDays;

/*	INTO	vOut;
 	RETURN vOut; */

END$$

DELIMITER ;

