DROP FUNCTION if exists remcon.fSavePeriod;

DELIMITER $$

/***********************
Crea o actualiza la tabla tPeriod si no existe el registro.
*/
CREATE FUNCTION remcon.fSavePeriod(pDate DATE) RETURNS BIGINT 
BEGIN
/** 
TODO: Hay que sacar el valor de la UF y Factor desde una tabla hist√≥rica 
por si hay que recalcular para atras...
*/
	DECLARE pOut BIGINT DEFAULT 0;

	SELECT	cUF, cOvertimeFactor 
	INTO	@uf, @overtimeFactor
	FROM	remcon.tMonthlyParameter
	WHERE	cDate = pDate;
	
	SELECT	cValue INTO @MinSalary
	FROM	remcon.tParameter
	WHERE	cKey = 'BASE_SALARY';

	IF EXISTS(	SELECT	cId 
				FROM	remcon.tPeriod
				WHERE	cDate = pDate) THEN
				
		UPDATE	remcon.tPeriod
		SET		cUF = @uf,
				cOvertimeFactor = @overtimeFactor,
				cMinSalary = @minSalary
		WHERE	cDate = pDate;
		
		SELECT	cId INTO pOut 
		FROM	remcon.tPeriod 
		WHERE	cDate = pDate; 
	ELSE
		INSERT INTO remcon.tPeriod(cDate, cUF, cOvertimeFactor, cMinSalary) 
		VALUES(pDate, @uf, @overtimeFactor, @minSalary);
		SET pOut = LAST_INSERT_ID();
	END IF;
	RETURN pOut;
END$$

DELIMITER ;