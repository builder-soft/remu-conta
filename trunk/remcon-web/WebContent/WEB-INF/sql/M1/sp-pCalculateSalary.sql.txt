DROP PROCEDURE if exists remcon.pCalculateSalary;
DROP PROCEDURE if exists remcon.pSaveOvertime;

DROP PROCEDURE if exists remcon.pGratificationAmount;

DROP FUNCTION if exists remcon.fSaveBookForEmployee;
DROP PROCEDURE IF EXISTS remcon.pSalaryReceived;
DROP PROCEDURE IF EXISTS remcon.pTotalIncomeTaxable;
DROP PROCEDURE IF EXISTS remcon.pOvertimeAmount;
DROP PROCEDURE IF EXISTS remcon.pLimitTaxableForecast;
DROP PROCEDURE IF EXISTS remcon.pLimitTaxableDismissInsurance;
DROP PROCEDURE IF EXISTS remcon.pIncome;
DROP PROCEDURE IF EXISTS remcon.pObligatoryQuote;


DROP FUNCTION IF EXISTS remcon.fGetLimitGratification;
DROP FUNCTION IF EXISTS remcon.fGetPFMForBook;

DELIMITER $$

/************************/
CREATE PROCEDURE remcon.pCalculateSalary(IN pEmployee BIGINT, IN pDate DATE, IN pWorkDays INTEGER)
BEGIN
	DECLARE vPeriod, vBook BIGINT DEFAULT 0; 

	SELECT	cId
	INTO	vPeriod
	FROM	remcon.tPeriod
	WHERE	cDate = pDate;

	SET vBook = remcon.fSaveBookForEmployee(vPeriod, pEmployee, pWorkDays);
	
	CALL remcon.pSaveOvertime(vBook, pEmployee, vPeriod);
	
	/*
	SET		vLimitGratification = fGetLimitGratification(vBook);
	UPDATE	remcon.tPeriod 
	SET		cLimitGratification = fGetLimitGratification(vBook)
	WHERE	cId = vPeriod;
	*/

	
/*	SET vSalaryReceived = fSalaryReceived(vBook);*/
	CALL remcon.pSalaryReceived(vBook);
	CALL remcon.pGratificationAmount(vBook);
	
	CALL remcon.pOvertimeAmount(vBook);
	CALL remcon.pTotalIncomeTaxable(vBook);
	
	CALL remcon.pLimitTaxableForecast(vBook);
	CALL remcon.pLimitTaxableDismissInsurance(vBook);
	
	CALL remcon.pObligatoryQuote(vBook);	
	
	CALL remcon.pIncome(vBook);

/*
	UPDATE	remcon.tBookAssets 
	SET		cOvertimeAmount = vOvertimeAmount
	WHERE	cBook = vBook;
*/


	/*
	UPDATE	remcon.tBook 
	SET		cSalaryReceived = vSalaryReceived 
	WHERE	cId = vBook;
	

	SET vObligatoryQuote = remcon.fGetObligatoryQuote(vBook);	

	UPDATE	remcon.tBookDiscounts
	SET		cObligatoryQuote = vObligatoryQuote
	WHERE	cBook = vBook;
*/
	
END$$

/************************/
CREATE PROCEDURE remcon.pTotalIncomeTaxable(pBook BIGINT)
BEGIN
	DECLARE vOut DOUBLE DEFAULT 0;

	SELECT	cB01 + cB02 + cB03 + cB04 + cB05 + 
			cB06 + cB07 + cB08 + cB09 + cB10 +
			cSalaryReceived + cGratificationAmount + cOvertimeAmount 
	INTO	vOut
	FROM	remcon.vBook
	WHERE	cId = pBook;

	UPDATE	remcon.tBookAssets 
	SET		cTotalIncomeTaxable = vOut
	WHERE	cBook = pBook;
	
	
END$$

/************************/
CREATE PROCEDURE remcon.pSalaryReceived(pBook BIGINT)
BEGIN
	/*
	DECLARE vOut DOUBLE DEFAULT 0;
	
	SELECT	cSalaryRoot / 30 * cWorkDays
	INTO	vOut
	FROM	remcon.vBook
	WHERE	cId = pBook;
	*/
	UPDATE	remcon.tBook 
	SET		cSalaryReceived = cSalaryRoot / 30 * cWorkDays 
	WHERE	cId = pBook;
	
END$$

/************************/
CREATE FUNCTION remcon.fSaveBookForEmployee(pPeriod BIGINT, pEmployee BIGINT, pWorkDays INTEGER) RETURNS BIGINT
BEGIN
	DECLARE vOut, vHorary, vGratificationType, vPFM, vHealth, vUnemploymentInsurance BIGINT DEFAULT 0;
	DECLARE vSalaryRoot DOUBLE DEFAULT 0;
	
	SELECT		b.cId 
	INTO		vOut
	FROM		remcon.tPeriod	AS a
	LEFT JOIN	remcon.tBook	AS b ON b.cPeriod = a.cId
	WHERE		b.cEmployee = pEmployee AND
				a.cId = pPeriod;

	SELECT	cHorary, cSalaryRoot, cGratificationType, cPFM, cHealth, cContractType
	INTO	vHorary, vSalaryRoot, vGratificationType, vPFM, vHealth, vUnemploymentInsurance
	FROM	remcon.tAgreement
	WHERE	cEmployee = pEmployee;
	
	SET vPFM = fGetPFMForBook(vPFM, pPeriod);
	
	IF (vOut != 0) THEN
		UPDATE	remcon.tBook
		SET		cPeriod = pPeriod,
				cEmployee = pEmployee,
				cHorary = vHorary,
				cWorkDays = pWorkDays,
				cSalaryRoot = vSalaryRoot,
				cOvertime = 0
		WHERE	cId = vOut;
		
		UPDATE	remcon.tBookAssets
		SET		cGratificationType = vGratificationType		
		WHERE	cBook = vOut;
		
		UPDATE	remcon.tBookDiscounts
		SET		cLimitTaxableForecast = 0,
				cPFMHistory = vPFM,
				cHealth = vHealth,
				cUnemploymentInsurance = vUnemploymentInsurance
		WHERE	cBook = vOut;
		
	ELSE
		INSERT INTO remcon.tBook(cPeriod, cEmployee, cHorary, cWorkDays, cSalaryRoot, cOvertime)
		VALUES(pPeriod, pEmployee, vHorary, pWorkDays, vSalaryRoot, 0);
		SET vOut = LAST_INSERT_ID();
		
		INSERT INTO remcon.tBookAssets(cBook, cGratificationType)
		VALUES(vOut, vGratificationType);
		
		INSERT INTO remcon.tBookDiscounts(cBook, cLimitTaxableForecast, cPFMHistory, cHealth, cUnemploymentInsurance)
		VALUES(vOut, 0, vPFM, vHealth, vUnemploymentInsurance);
	END IF;

	RETURN vOut;
END$$

/************************/
CREATE FUNCTION remcon.fGetPFMForBook(pPFM BIGINT, pPeriod BIGINT) RETURNS BIGINT
BEGIN
	DECLARE vOut BIGINT DEFAULT 0;
	DECLARE vKey VARCHAR(2) DEFAULT ' ';

	SELECT 	cKey
	INTO	vKey 
	FROM	remcon.tPFM
	WHERE	cId = pPFM;

	SELECT 	cId
	INTO	vOut 
	FROM	remcon.tPFMHistory
	WHERE	cKey = vKey AND cPeriod <= pPeriod
	ORDER BY cId DESC
	LIMIT 0, 1;
	
	RETURN vOut;
END$$

/************************/
CREATE PROCEDURE remcon.pSaveOvertime(IN pBook BIGINT, IN pEmployee BIGINT, IN pPeriod BIGINT)
BEGIN
	DECLARE pHours INTEGER DEFAULT 0;

	SELECT	SUM(cHours) INTO pHours 
	FROM	remcon.tOvertime
	WHERE	cEmployee = pEmployee AND 
			cPeriod = pPeriod;
	
	IF(pHours IS NULL) THEN
		SET pHours = 0;
	END IF;
	
	UPDATE	remcon.tBook 
	SET		cOvertime = pHours
	WHERE	cId = pBook;
	
END$$

/************************/
CREATE PROCEDURE remcon.pGratificationAmount(pBook BIGINT)
BEGIN
	DECLARE vOut, vSalaryReceived, vMinSalary, vOvertimeAmount, vParticipation,
			vB01, vB02, vB03, vB04, vB05, vB06, vB07, vB08, vB09, vB10,
			vLimit, vSumGratificaion, vLimitGratification DOUBLE DEFAULT 0;
	DECLARE vGratificationType BIGINT DEFAULT 0;
	
	SELECT	cGratificationType, cSalaryReceived, cMinSalary, cOvertimeAmount, cParticipation,
			cB01, cB02, cB03, cB04, cB05, cB06, cB07, cB08, cB09, cB10, cLimitGratification
	INTO	vGratificationType, vSalaryReceived, vMinSalary, vOvertimeAmount, vParticipation,
			vB01, vB02, vB03, vB04, vB05, vB06, vB07, vB08, vB09, vB10, vLimitGratification
	FROM	remcon.vBook
	WHERE	cId = pBook;
	 
	IF(vGratificationType = 1) THEN /* Sin Gratificacion */
		SET vOut = 0;
		
	ELSEIF (vGratificationType = 2) THEN /* Gratificacion : 25% Impo. (Tope 4,75imm/12)*/
	/*
		SET vLimit = 4.75 * vMinSalary;
		SET vLimit = cLimitGratification;
*/		
		SET vSumGratificaion =	vSalaryReceived + vOvertimeAmount + vParticipation + 
								vB01 + vB02 + vB03 + vB04 + vB05 + 
								vB06 + vB07 + vB08 + vB09 + vB10;
								
		IF(vSumGratificaion * 0.25 > vLimitGratification) THEN
			SET vOut = vLimitGratification;
		ELSE
			SET vOut = vSumGratificaion * 0.25;

		END IF;
				
	ELSE /* Por antiguedad */
		SET vOut = vSalaryReceived * 0.25;
	END IF;
	
	UPDATE	remcon.tBookAssets 
	SET		cGratificationAmount = vOut
	WHERE	cBook = pBook;
	
END$$

/************************/
CREATE PROCEDURE remcon.pOvertimeAmount(pBook BIGINT) 
BEGIN
	DECLARE vOut DOUBLE DEFAULT 0;

	SELECT 	(a.cSalaryRoot * b.cOvertimeFactor) * a.cOvertime
	INTO	vOut 
	FROM	remcon.tBook		AS a
	LEFT JOIN remcon.tPeriod	AS b ON a.cPeriod = b.cId
	WHERE	a.cId = pBook;
	
	UPDATE	remcon.tBookAssets 
	SET		cOvertimeAmount = vOut
	WHERE	cBook = pBook;
	
END$$

/************************/
CREATE FUNCTION remcon.fGetLimitGratification(pBook BIGINT) RETURNS DOUBLE
BEGIN
/*4.75 Ingresos mÃ­nimos*/
	DECLARE vOut DOUBLE DEFAULT 0;
	
	SELECT 	cMinSalary * cGratificationFactor
	INTO	vOut 
	FROM	remcon.vBook
	WHERE	cId = pBook;
	
	RETURN vOut;
END$$

/************************/
CREATE PROCEDURE remcon.pLimitTaxableForecast(pBook BIGINT)
BEGIN
/**
 	cLimitIPS_CLP = cLimitIPS * UF 
  	SI(cTotalIncomeTaxable>=cLimitIPS_CLP) THEN
  		cLimitIPS_CLP
	ELSE
		cTotalIncomeTaxable
	END IF
* */
	DECLARE vOut, vLimitIPSasCLP, vTotalIncomeTaxable DOUBLE DEFAULT 0;
	
	SELECT 	(cLimitIPS * cUF), cTotalIncomeTaxable 
	INTO	vLimitIPSasCLP, vTotalIncomeTaxable
	FROM	remcon.vBook
	WHERE	cId = pBook;
	
	IF(vTotalIncomeTaxable>=vLimitIPSasCLP) THEN
		SET vOut = vLimitIPSasCLP;
	ELSE
		SET vOut = vTotalIncomeTaxable;
	END IF;
	
	/*
	RETURN vOut;
	*/
	UPDATE	remcon.tBookDiscounts
	SET		cLimitTaxableForecast = vOut
	WHERE	cBook = pBook;
	
END$$

CREATE PROCEDURE remcon.pLimitTaxableDismissInsurance(pBook BIGINT)
BEGIN
/* = SI(cTotalIncomeTaxable >= 90UF ; 90UF; cTotalIncomeTaxable) */
	DECLARE vTotalIncomeTaxable, vUFs, vLimit, vOut DOUBLE DEFAULT 0;

	SELECT 	cTotalIncomeTaxable, (cUF * cLimitInsurance)
	INTO	vTotalIncomeTaxable, vLimit
	FROM	remcon.vBook
	WHERE	cId = pBook;
	
	IF (vTotalIncomeTaxable >= vLimit) THEN
		SET vOut = vLimit;
	ELSE
		SET vOut = vTotalIncomeTaxable;
	END IF;
		
	UPDATE	remcon.tBookDiscounts
	SET		cLimitTaxableDismissInsurance = vOut
	WHERE	cBook = pBook;
	
END$$



CREATE PROCEDURE remcon.pIncome(pBook BIGINT)
BEGIN
/* =cTotalIncomeTaxable-cObligatoryQuote-APV-(COT SALUD REBAJA)BA13-(SEGURO CESANTIA)BC13 */
	
	/*
	DECLARE vTotalIncomeTaxable, vUFs, vLimit, vOut DOUBLE DEFAULT 0;

	SELECT 	cTotalIncomeTaxable, (cUF * cLimitInsurance)
	INTO	vTotalIncomeTaxable, vLimit
	FROM	remcon.vBook
	WHERE	cId = pBook;
	
	IF (vTotalIncomeTaxable >= vLimit) THEN
		SET vOut = vLimit;
	ELSE
		SET vOut = vTotalIncomeTaxable;
	END IF;
		
	UPDATE	remcon.tBookDiscounts
	SET		cLimitTaxableDismissInsurance = vOut
	WHERE	cBook = pBook;
	*/
END$$



CREATE PROCEDURE remcon.pObligatoryQuote(pBook BIGINT)
BEGIN
/**
 SI(AFP=Cuprum		;cLimitTaxableForecast*11.48;
 SI(AFP=Habitat		;cLimitTaxableForecast*11.36;
 SI(AFP=Planvital	;cLimitTaxableForecast*12.36;
 SI(AFP=Provida		;cLimitTaxableForecast*11.54;
 SI(AFP=IngCapital	;cLimitTaxableForecast*11.44;
 SI(AFP=Jubilado	;cLimitTaxableForecast*0;
 SI(AFP=INP(EMPART)	;cLimitTaxableForecast*21.84;
 SI(AFP=INP(Ex-SSS)	;cLimitTaxableForecast*18.84;0))))))))
*/
	DECLARE vOut, vLimitTaxableForecast, vFactor DOUBLE DEFAULT 0;
	DECLARE vPFMHistory BIGINT DEFAULT 0;
	
	SELECT	cLimitTaxableForecast, cPFMHistory
	INTO	vLimitTaxableForecast, vPFMHistory
	FROM	remcon.vBook
	WHERE	cId = pBook;
		
	SELECT	cFactor
	INTO	vFactor
	FROM	remcon.tPFMHistory
	WHERE	cId = vPFMHistory;
	
	SET	vOut = vLimitTaxableForecast * (vFactor/100);
	
	UPDATE	remcon.tBookDiscounts
	SET		cObligatoryQuote = vOut
	WHERE	cBook = pBook;
	
END$$

DELIMITER ;
