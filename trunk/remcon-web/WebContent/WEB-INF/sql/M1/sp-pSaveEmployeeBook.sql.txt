DROP PROCEDURE if exists remcon.pSaveEmployeeBook;
DELIMITER $$

CREATE PROCEDURE remcon.pSaveEmployeeBook(IN pEmployee BIGINT, IN pDate DATE)
BEGIN
	DECLARE pPeriod BIGINT DEFAULT 0; 

	CALL remcon.pSavePeriod(pDate, pPeriod);
	
	SELECT	cHorary, cSalaryRoot, 30, 0, cGratificationType INTO @horary, @salaryRoot, @workDays, @overtime, @gratificationType
	FROM	remcon.tAgreement
	WHERE	cEmployee = pEmployee;

/*
	SELECT		*
				FROM		remcon.tPeriod AS a
				LEFT JOIN	remcon.tBook AS b ON b.cPeriod = a.cId
				WHERE		b.cEmployee = pEmployee AND
							a.cDate = pDate;
*/
						
	SELECT		b.cId INTO @bookId
				FROM		remcon.tPeriod AS a
				LEFT JOIN	remcon.tBook AS b ON b.cPeriod = a.cId
				WHERE		b.cEmployee = pEmployee AND
							a.cDate = pDate;
	
	
	IF @bookId IS NOT NULL THEN
		UPDATE	remcon.tBook
		SET		cPeriod = pPeriod,
				cEmployee = pEmployee,
				cHorary = @horary,
				cWorkDays = @workDays,
				cSalaryRoot = @salaryRoot,
				cOvertime = @overtime
		WHERE	cId = @bookId;
		
				
		UPDATE	remcon.tBookAssets
		SET		cGratificationType = @gratificationType		
		WHERE	cId = @bookId;
	ELSE
		INSERT INTO tBook(cPeriod, cEmployee, cHorary, cWorkDays, cSalaryRoot, cOvertime)
		VALUES(pPeriod, pEmployee, @horary, 30, @salaryRoot, 0);
		
		SET @bookId = LAST_INSERT_ID();
		
		INSERT INTO remcon.tBookAssets(cBook, cGratificationType)
		VALUES(@bookId, @gratificationType);
		
	END IF;
	
END$$

DELIMITER ;
