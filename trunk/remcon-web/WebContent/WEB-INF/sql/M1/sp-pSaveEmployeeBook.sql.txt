DROP PROCEDURE if exists remcon.pSaveEmployeeBook;
DROP FUNCTION if exists remcon.fGetGratificationAmount;
DROP FUNCTION if exists remcon.fSavePeriod;
DROP FUNCTION if exists remcon.fSaveBookForEmployee;
DROP FUNCTION if exists remcon.fGetOvertimeAmount;

DELIMITER $$

/************************/
CREATE PROCEDURE remcon.pSaveEmployeeBook(IN pEmployee BIGINT, IN pDate DATE, IN pWorkDays INTEGER)
BEGIN
	DECLARE pPeriod BIGINT DEFAULT 0; 
	DECLARE pBook BIGINT DEFAULT 0; 
	DECLARE pGratificationAmount DOUBLE DEFAULT 0;
	DECLARE pOvertimeAmount DOUBLE DEFAULT 0;

	SET pPeriod = remcon.fSavePeriod(pDate);
	SET pBook = remcon.fSaveBookForEmployee(pPeriod, pEmployee, pDate, pWorkDays);
	
	SET pOvertimeAmount = remcon.fGetOvertimeAmount(pEmployee, pDate);
	
	SET pGratificationAmount = fGetGratificationAmount(pBook);
	
	select pGratificationAmount;
END$$



/***********************
Crea o actualiza la tabla tPeriod si no existe.
*/
CREATE FUNCTION remcon.fSavePeriod(pDate DATE) RETURNS BIGINT 
BEGIN
/** 
TODO: Hay que sacar el valor de la UF y Factor desde una tabla hist√≥rica 
por si hay que recalcular para atras
*/
	DECLARE pOut BIGINT DEFAULT 0;

	SELECT	cUF, cOvertimeFactor 
	INTO	@uf, @overtimeFactor
	FROM	remcon.tMonthlyParameter
	WHERE	cDate = pDate;

	IF EXISTS(	SELECT	cId 
				FROM	remcon.tPeriod
				WHERE	cDate = pDate) THEN
				
		UPDATE	remcon.tPeriod
		SET		cUF = @uf,
				cOvertimeFactor = @overtimeFactor
		WHERE	cDate = pDate;
		
		SELECT	cId INTO pOut 
		FROM	remcon.tPeriod 
		WHERE	cDate = pDate; 
	ELSE
		INSERT INTO remcon.tPeriod(cDate, cUF, cOvertimeFactor) 
		VALUES(pDate, @uf, @overtimeFactor);
		SET pOut = LAST_INSERT_ID();
	END IF;
	RETURN pOut;
END$$

/************************/
CREATE FUNCTION remcon.fSaveBookForEmployee(pPeriod BIGINT, pEmployee BIGINT, pDate DATE, pWorkDays INTEGER) RETURNS BIGINT
BEGIN
	SELECT		b.cId INTO @bookId
				FROM		remcon.tPeriod AS a
				LEFT JOIN	remcon.tBook AS b ON b.cPeriod = a.cId
				WHERE		b.cEmployee = pEmployee AND
							a.cDate = pDate;
	
	SELECT	cHorary, cSalaryRoot, 0,			cGratificationType 
	INTO	@horary, @salaryRoot, @overtime,	@gratificationType
	FROM	remcon.tAgreement
	WHERE	cEmployee = pEmployee;
	
	IF @bookId IS NOT NULL THEN
		UPDATE	remcon.tBook
		SET		cPeriod = pPeriod,
				cEmployee = pEmployee,
				cHorary = @horary,
				cWorkDays = pWorkDays,
				cSalaryRoot = @salaryRoot,
				cOvertime = @overtime
		WHERE	cId = @bookId;
		
		UPDATE	remcon.tBookAssets
		SET		cGratificationType = @gratificationType		
		WHERE	cId = @bookId;
	ELSE
		INSERT INTO tBook(cPeriod, cEmployee, cHorary, cWorkDays, cSalaryRoot, cOvertime)
		VALUES(pPeriod, pEmployee, @horary, pWorkDays, @salaryRoot, @overtime);
		
		SET @bookId = LAST_INSERT_ID();
		
		INSERT INTO remcon.tBookAssets(cBook, cGratificationType)
		VALUES(@bookId, @gratificationType);
		
	END IF;
	RETURN @bookId;
END$$

/************************/
CREATE FUNCTION remcon.fGetOvertimeAmount(pEmployee BIGINT, pDate DATE) RETURNS DOUBLE
BEGIN
	RETURN 1240;
END$$

/************************/
CREATE FUNCTION remcon.fGetGratificationAmount(pBook BIGINT) RETURNS DOUBLE
BEGIN
	DECLARE pGratificationAmount DOUBLE DEFAULT 0;
	
	SELECT	cGratificationType, cSalaryReceived
	INTO	@GratificationType, @SalaryReceived
	FROM	remcon.vBook
	WHERE	cId = pBook;
	 
	IF(@GratificationType = 1) THEN /* Sin Gratificacion */
		SET pGratificationAmount = 0;
	ELSEIF (@GratificationType = 2) THEN /* Gratificacion : 25% Impo. (Tope 4,75imm/12)*/
		SET @sumGratificaion = @SalaryReceived + 1;

		SET pGratificationAmount = @sumGratificaion;
		
	ELSEIF (@GratificationType = 3) THEN /* Por antiguedad */
		SET pGratificationAmount = 0;
	END IF;
	
	RETURN pGratificationAmount;
END$$

DELIMITER ;
